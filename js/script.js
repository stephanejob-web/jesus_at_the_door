// === TRANSLATIONS ===
const translations = {
    fr: {
        languageScreen: {
            title: "Choisissez votre langue",
            subtitle: "Choose your language"
        },
        home: {
            verse: "Voici, je me tiens √† la porte, et je frappe. Si quelqu'un entend ma voix et ouvre la porte, j'entrerai chez lui.",
            reference: "Apocalypse 3:20",
            startBtn: "Commencer"
        },
        name: {
            title: "Quel est votre pr√©nom ?",
            placeholder: "Entrez votre pr√©nom",
            continueBtn: "Continuer"
        },
        progress: {
            step: "√âtape"
        },
        navigation: {
            previous: "‚Üê Pr√©c√©dent",
            next: "Suivant ‚Üí"
        },
        answers: {
            yes: "Oui",
            no: "Non",
            doubt: "J'ai un doute"
        },
        questions: {
            q1_image: "Avez-vous d√©j√† vu cette image ?",
            q1_pray: "Priez-vous ?",
            q_believe_god: "Croyez-vous en Dieu ?",
            q_doubt_verse: "Dieu dit :\n\n¬´ Approchez-vous de Dieu, et il s'approchera de vous. ¬ª\n‚Äî Jacques 4:8\n\nDieu vous attend avec amour. Il comprend vos doutes et d√©sire marcher avec vous.",
            q_doubt_continue: "Voulez-vous continuer ?",
            q_continue: "Voulez-vous continuer ?",
            q2: "Voici, J√©sus frappe √† la porte de votre c≈ìur. La poign√©e est √† l'int√©rieur, vous √™tes la seule personne √† pouvoir Le laisser entrer.",
            q4: "Imaginez porter sur vos √©paules un sac contenant tous vos p√©ch√©s. Pas seulement les \"gros\" p√©ch√©s, mais aussi les petits mensonges, les mauvaises pens√©es, les paroles blessantes... Ce poids, c'est ce qui brise la relation avec Dieu.",
            q4_question: "Selon vous, votre sac contiendrait-il des choses ?",
            q4_verse: "La Bible dit :\n\n¬´ Car tous ont p√©ch√© et sont priv√©s de la gloire de Dieu. ¬ª\n‚Äî Romains 3:23\n\nNous avons tous besoin de la gr√¢ce de Dieu.",
            q4_continue: "Voulez-vous continuer ?",
            q5: "Si vous deviez un million d'Euros √† la banque et que je vous donne un ch√®que de ce montant et que vous le remettiez √† la banque, qu'adviendrait-il de votre dette ?",
            q5_question: "Votre dette serait effac√©e ?",
            q6: "C'est ce que J√©sus a fait lorsqu'Il est mort sur la croix, {name}.\n\nIl vous a fait un ch√®que sign√© de Son sang - avec votre nom ¬´ {name} ¬ª √©crit dessus.\n\nIl est ressuscit√©, et aujourd'hui, Il se tient √† la porte de votre c≈ìur, d√©sirant que vous l'encaissiez.",
            q7: "Si J√©sus √©tait ici en ce moment, Le laisseriez-vous entrer ?",
            q8: "Pouvez-vous voir le vent ? Non, mais vous pouvez le sentir, n'est-ce pas ? Comme le vent, J√©sus est ici en ce moment.",
            q8_question: "Puis-je prier pour que vous sentiez Sa pr√©sence ?",
            prayer: "J√©sus,\n\nJe te prie pour {name} en cet instant.\n\nR√©v√®le-toi √† {name}, fais-lui ressentir ta pr√©sence.\nQue ton amour infini touche son c≈ìur profond√©ment.\n\nJ√©sus, je te prie, fais entendre √† {name} que tu frappes √† la porte de son c≈ìur.\n\nRemplis {name} de ta paix,\net de ta lumi√®re qui dissipe toutes t√©n√®bres.\n\nSeigneur J√©sus, b√©nis {name} abondamment.\n\nAu nom de J√©sus,\nAmen.",
            q9_felt: "Avez-vous ressenti la pr√©sence de Dieu ?",
            q10_follow: "En ce moment, vous √™tes sur un chemin de vie sans J√©sus. Vous devez vous d√©tourner de votre p√©ch√©, changer de direction et Le suivre.",
            q10_question: "Voulez-vous Le suivre ?",
            q11_faith: "Par la foi, croyez-vous que J√©sus est ici en ce moment ?",
            q_repeat_prayer: "Si tu veux vraiment suivre J√©sus, r√©p√®te cette pri√®re avec moi :\n\nJ√©sus, pardonne-moi mes p√©ch√©s.\nJ'ouvre la porte de mon c≈ìur.\nJe te fais Seigneur de ma vie.\nRemplis-moi de ton Esprit.\n\nAmen.",
            q_repeat_prayer_question: "As-tu r√©p√©t√© cette pri√®re ?",
            final_reflection: "Merci pour ton honn√™tet√©, {name}.\n\nJ√©sus respecte ton choix et continue de t'aimer.\n\n¬´ Car Dieu a tant aim√© le monde qu'il a donn√© son Fils unique. ¬ª\n‚Äî Jean 3:16\n\nLa porte reste ouverte. Toujours.\nTu peux revenir quand tu veux.\n\nQue Dieu te b√©nisse.",
            final_god_believes: "Dieu vous aime d'un amour infini.\n\n¬´ Car Dieu a tant aim√© le monde qu'il a donn√© son Fils unique, afin que quiconque croit en lui ne p√©risse pas, mais qu'il ait la vie √©ternelle. ¬ª\n‚Äî Jean 3:16\n\n¬´ J'ai mis devant toi la vie et la mort, la b√©n√©diction et la mal√©diction. Choisis la vie, afin que tu vives, toi et ta post√©rit√©. ¬ª\n‚Äî Deut√©ronome 30:19\n\nLa porte reste toujours ouverte.\nDieu vous attend, les bras ouverts."
        },
        finalScreen: {
            title: "Bienvenue dans ta nouvelle vie avec J√©sus !",
            prayerText: "J√©sus, pardonne-moi mes p√©ch√©s. J'ouvre la porte de mon c≈ìur. Je te fais Seigneur de ma vie. Remplis-moi de ton Esprit.",
            amen: "Amen.",
            welcomeMessage: "Aujourd'hui, tu as ouvert ton c≈ìur ‚ù§Ô∏è √† J√©sus-Christ. C'est la plus belle d√©cision de ta vie ! Une nouvelle aventure commence pour toi.",
            journeyTitle: "üö∂‚Äç‚ôÇÔ∏è Marcher avec J√©sus, chaque jour",
            journeyText: "Dire \"oui\" √† J√©sus, c'est un bon d√©part. Mais l'essentiel, c'est de continuer chaque jour. J√©sus t'appelle √† une relation vivante avec Lui ‚Äì pas juste un moment fort, mais une vie enti√®re √† Ses c√¥t√©s.",
            teachingTitle: "üìñ Ce que J√©sus nous enseigne",
            teachingText: "J√©sus a dit que la Parole de Dieu est comme une graine, et ton c≈ìur est comme un sol. Il y a 4 types de c≈ìurs. Aujourd'hui, lequel est le tien ?",
            heart1Title: "1. Le bord du chemin",
            heart1Desc: "Tu entends le message, mais tu ne fais pas attention. Ton c≈ìur est ferm√©.",
            heart1Consequence: "üëâ Le diable t'enl√®ve ce que Dieu voulait te donner.",
            heart2Title: "2. Le sol pierreux",
            heart2Desc: "Tu √©coutes avec joie, mais √ßa ne va pas profond.",
            heart2Consequence: "üëâ D√®s que √ßa devient dur, tu abandonnes. Tu n'es pas vraiment d√©cid√© √† suivre J√©sus.",
            heart3Title: "3. Les ronces",
            heart3Desc: "Tu veux croire, mais tu es √©touff√© par les soucis.",
            heart3Consequence: "üëâ Tu es stress√©, inquiet, submerg√© par les probl√®mes, l'argent ou des blessures du pass√©‚Ä¶ La Parole entre, mais elle ne reste pas. Elle est √©touff√©e par tes pr√©occupations, et ne peut pas produire de changement en toi.",
            heart4Title: "4. La bonne terre",
            heart4Desc: "Tu entends, tu ouvres ton c≈ìur, tu te repens, et tu laisses J√©sus te transformer.",
            heart4Consequence: "üëâ Ta vie change. Tu vis pour Dieu. Et tu portes du fruit.",
            encouragementTitle: "‚ú® Mon encouragement pour toi",
            encouragementText: "Ne laisse rien voler ce que Dieu a commenc√© en toi ! Reste connect√© √† J√©sus en :",
            encouragement1: "Lui parlant chaque jour",
            encouragement2: "Lisant la Bible",
            encouragement3: "Venant √† l'√©glise",
            bibleQuote: "Celui qui a commenc√© en vous cette bonne ≈ìuvre la rendra parfaite.",
            bibleQuoteRef: "‚Äî Philippiens 1:6",
            bookTitle: "üéÅ D√©couvre \"Suivre J√©sus\"",
            bookSubtitle: "Un guide pour bien commencer ta nouvelle vie avec Dieu",
            bookDesc1: "Le livret Suivre J√©sus est un outil simple et puissant pour t'aider √† comprendre ce que signifie suivre J√©sus au quotidien. Il a √©t√© con√ßu pour accompagner ceux qui veulent vraiment avancer avec Dieu.",
            bookDesc2: "Tu y d√©couvriras les bases essentielles pour grandir dans ta foi et marcher chaque jour avec J√©sus.",
            downloadBtn: "T√©l√©charger le livre",
            restartBtn: "Recommencer"
        }
    },
    en: {
        languageScreen: {
            title: "Choose your language",
            subtitle: "Choisissez votre langue"
        },
        home: {
            verse: "Behold, I stand at the door and knock. If anyone hears My voice and opens the door, I will come in to him.",
            reference: "Revelation 3:20",
            startBtn: "Start"
        },
        name: {
            title: "What is your first name?",
            placeholder: "Enter your first name",
            continueBtn: "Continue"
        },
        progress: {
            step: "Step"
        },
        navigation: {
            previous: "‚Üê Previous",
            next: "Next ‚Üí"
        },
        answers: {
            yes: "Yes",
            no: "No",
            doubt: "I have doubts"
        },
        questions: {
            q1_image: "Have you ever seen this image?",
            q1_pray: "Do you pray?",
            q_believe_god: "Do you believe in God?",
            q_doubt_verse: "God says:\n\n\"Come near to God and he will come near to you.\"\n‚Äî James 4:8\n\nGod is waiting for you with love. He understands your doubts and desires to walk with you.",
            q_doubt_continue: "Do you want to continue?",
            q_continue: "Do you want to continue?",
            q2: "Behold, Jesus is knocking at the door of your heart. The handle is on the inside, you are the only one who can let Him in.",
            q4: "Imagine carrying on your shoulders a bag containing all your sins. Not just the \"big\" sins, but also the little lies, the bad thoughts, the hurtful words... This weight is what breaks the relationship with God.",
            q4_question: "In your opinion, would your bag contain anything?",
            q4_verse: "The Bible says:\n\n\"For all have sinned and fall short of the glory of God.\"\n‚Äî Romans 3:23\n\nWe all need God's grace.",
            q4_continue: "Do you want to continue?",
            q5: "If you owed the bank a million Euros and I gave you a check for that amount and you gave it to the bank, what would happen to your debt?",
            q5_question: "Would your debt be erased?",
            q6: "This is what Jesus did when He died on the cross, {name}.\n\nHe made you a check signed with His blood - with your name \"{name}\" written on it.\n\nHe rose again, and today, He stands at the door of your heart, desiring you to cash it.",
            q7: "If Jesus were here right now, would you let Him in?",
            q8: "Can you see the wind? No, but you can feel it, can't you? Like the wind, Jesus is here right now.",
            q8_question: "May I pray that you feel His presence?",
            prayer: "Jesus,\n\nI pray for {name} in this moment.\n\nReveal yourself to {name}, let them feel your presence.\nMay your infinite love touch their heart deeply.\n\nJesus, I pray, let {name} hear that you are knocking at the door of their heart.\n\nFill {name} with your peace,\nand your light that dispels all darkness.\n\nLord Jesus, bless {name} abundantly.\n\nIn Jesus' name,\nAmen.",
            q9_felt: "Did you feel God's presence?",
            q10_follow: "Right now, you are on a life path without Jesus. You must turn away from your sin, change direction and follow Him.",
            q10_question: "Do you want to follow Him?",
            q11_faith: "By faith, do you believe that Jesus is here right now?",
            q_repeat_prayer: "If you really want to follow Jesus, repeat this prayer with me:\n\nJesus, forgive me my sins.\nI open the door of my heart.\nI make you Lord of my life.\nFill me with your Spirit.\n\nAmen.",
            q_repeat_prayer_question: "Have you repeated this prayer?",
            final_reflection: "Thank you for your honesty, {name}.\n\nJesus respects your choice and continues to love you.\n\n\"For God so loved the world that he gave his one and only Son.\"\n‚Äî John 3:16\n\nThe door remains open. Always.\nYou can come back whenever you want.\n\nMay God bless you.",
            final_god_believes: "God loves you with infinite love.\n\n\"For God so loved the world that he gave his one and only Son, that whoever believes in him shall not perish but have eternal life.\"\n‚Äî John 3:16\n\n\"I have set before you life and death, blessings and curses. Now choose life, so that you and your children may live.\"\n‚Äî Deuteronomy 30:19\n\nThe door always remains open.\nGod is waiting for you, with open arms."
        },
        finalScreen: {
            title: "Welcome to your new life with Jesus!",
            prayerText: "Jesus, forgive me my sins. I open the door of my heart. I make you Lord of my life. Fill me with your Spirit.",
            amen: "Amen.",
            welcomeMessage: "Today, you have opened your heart ‚ù§Ô∏è to Jesus Christ. This is the best decision of your life! A new adventure begins for you.",
            journeyTitle: "üö∂‚Äç‚ôÇÔ∏è Walking with Jesus, every day",
            journeyText: "Saying \"yes\" to Jesus is a good start. But the essential thing is to continue every day. Jesus calls you to a living relationship with Him ‚Äì not just a strong moment, but a lifetime by His side.",
            teachingTitle: "üìñ What Jesus teaches us",
            teachingText: "Jesus said that the Word of God is like a seed, and your heart is like soil. There are 4 types of hearts. Today, which one is yours?",
            heart1Title: "1. The path",
            heart1Desc: "You hear the message, but you don't pay attention. Your heart is closed.",
            heart1Consequence: "üëâ The devil takes away what God wanted to give you.",
            heart2Title: "2. The rocky soil",
            heart2Desc: "You listen with joy, but it doesn't go deep.",
            heart2Consequence: "üëâ As soon as it gets hard, you give up. You're not really decided to follow Jesus.",
            heart3Title: "3. The thorns",
            heart3Desc: "You want to believe, but you are choked by worries.",
            heart3Consequence: "üëâ You are stressed, anxious, overwhelmed by problems, money or past hurts... The Word enters, but it doesn't stay. It is choked by your concerns, and cannot produce change in you.",
            heart4Title: "4. The good soil",
            heart4Desc: "You hear, you open your heart, you repent, and you let Jesus transform you.",
            heart4Consequence: "üëâ Your life changes. You live for God. And you bear fruit.",
            encouragementTitle: "‚ú® My encouragement for you",
            encouragementText: "Don't let anything steal what God has started in you! Stay connected to Jesus by:",
            encouragement1: "Talking to Him every day",
            encouragement2: "Reading the Bible",
            encouragement3: "Coming to church",
            bibleQuote: "He who began a good work in you will carry it on to completion.",
            bibleQuoteRef: "‚Äî Philippians 1:6",
            bookTitle: "üéÅ Discover \"Following Jesus\"",
            bookSubtitle: "A guide to start your new life with God well",
            bookDesc1: "The Following Jesus booklet is a simple and powerful tool to help you understand what it means to follow Jesus daily. It was designed to accompany those who really want to move forward with God.",
            bookDesc2: "You will discover the essential basics to grow in your faith and walk with Jesus every day.",
            downloadBtn: "Download the book",
            restartBtn: "Restart"
        }
    }
};

// === DATA ===
const questionFlow = [
    {
        id: 'q1_image',
        text: "Avez-vous d√©j√† vu cette image ?",
        type: 'question',
        special: true,
        next: { yes: 'q1_pray', no: 'q1_pray' }
    },
    {
        id: 'q1_pray',
        text: "Priez-vous ?",
        type: 'question',
        next: { yes: 'q2', no: 'q_believe_god' }
    },
    {
        id: 'q_believe_god',
        text: "Croyez-vous en Dieu ?",
        type: 'question_three',
        next: { yes: 'q_continue', no: 'final_god_believes', doubt: 'q_doubt_verse' }
    },
    {
        id: 'q_doubt_verse',
        text: "Dieu dit :\n\n¬´ Approchez-vous de Dieu, et il s'approchera de vous. ¬ª\n‚Äî Jacques 4:8\n\nDieu vous attend avec amour. Il comprend vos doutes et d√©sire marcher avec vous.",
        type: 'text',
        special: true,
        nextId: 'q_doubt_continue'
    },
    {
        id: 'q_doubt_continue',
        text: "Voulez-vous continuer ?",
        type: 'question',
        next: { yes: 'q2', no: 'final_god_believes' }
    },
    {
        id: 'q_continue',
        text: "Voulez-vous continuer ?",
        type: 'question',
        next: { yes: 'q2', no: 'final_god_believes' }
    },
    {
        id: 'q2',
        text: "Voici, J√©sus frappe √† la porte de votre c≈ìur. La poign√©e est √† l'int√©rieur, vous √™tes la seule personne √† pouvoir Le laisser entrer.",
        type: 'text'
    },
    {
        id: 'q4',
        text: "Imaginez porter sur vos √©paules un sac contenant tous vos p√©ch√©s. Pas seulement les \"gros\" p√©ch√©s, mais aussi les petits mensonges, les mauvaises pens√©es, les paroles blessantes... Ce poids, c'est ce qui brise la relation avec Dieu.",
        type: 'question',
        question: "Selon vous, votre sac contiendrait-il des choses ?",
        next: { yes: 'q5', no: 'q4_verse' }
    },
    {
        id: 'q4_verse',
        text: "La Bible dit :\n\n¬´ Car tous ont p√©ch√© et sont priv√©s de la gloire de Dieu. ¬ª\n‚Äî Romains 3:23\n\nNous avons tous besoin de la gr√¢ce de Dieu.",
        type: 'text',
        special: true,
        nextId: 'q4_continue'
    },
    {
        id: 'q4_continue',
        text: "Voulez-vous continuer ?",
        type: 'question',
        next: { yes: 'q5', no: 'final_god_believes' }
    },
    {
        id: 'q5',
        text: "Si vous deviez un million d'Euros √† la banque et que je vous donne un ch√®que de ce montant et que vous le remettiez √† la banque, qu'adviendrait-il de votre dette ?",
        type: 'question_yes_only',
        question: "Votre dette serait effac√©e ?",
        next: { yes: 'q6' }
    },
    {
        id: 'q6',
        text: "C'est ce que J√©sus a fait lorsqu'Il est mort sur la croix, {name}.\n\nIl vous a fait un ch√®que sign√© de Son sang - avec votre nom ¬´ {name} ¬ª √©crit dessus.\n\nIl est ressuscit√©, et aujourd'hui, Il se tient √† la porte de votre c≈ìur, d√©sirant que vous l'encaissiez.",
        type: 'text',
        special: true
    },
    {
        id: 'q7',
        text: "Si J√©sus √©tait ici en ce moment, Le laisseriez-vous entrer ?",
        type: 'question_yes_only',
        next: { yes: 'q8' }
    },
    {
        id: 'q8',
        text: "Pouvez-vous voir le vent ? Non, mais vous pouvez le sentir, n'est-ce pas ? Comme le vent, J√©sus est ici en ce moment.",
        type: 'question_yes_only',
        question: "Puis-je prier pour que vous sentiez Sa pr√©sence ?",
        next: { yes: 'prayer' }
    },
    {
        id: 'prayer',
        text: "J√©sus,\n\nJe te prie pour {name} en cet instant.\n\nR√©v√®le-toi √† {name}, fais-lui ressentir ta pr√©sence.\nQue ton amour infini touche son c≈ìur profond√©ment.\n\nJ√©sus, je te prie, fais entendre √† {name} que tu frappes √† la porte de son c≈ìur.\n\nRemplis {name} de ta paix,\net de ta lumi√®re qui dissipe toutes t√©n√®bres.\n\nSeigneur J√©sus, b√©nis {name} abondamment.\n\nAu nom de J√©sus,\nAmen.",
        type: 'text',
        special: true,
        nextId: 'q9_felt'
    },
    {
        id: 'q9_felt',
        text: "Avez-vous ressenti la pr√©sence de Dieu ?",
        type: 'question',
        next: { yes: 'q10_follow', no: 'q11_faith' }
    },
    {
        id: 'q10_follow',
        text: "En ce moment, vous √™tes sur un chemin de vie sans J√©sus. Vous devez vous d√©tourner de votre p√©ch√©, changer de direction et Le suivre.",
        type: 'question',
        question: "Voulez-vous Le suivre ?",
        next: { yes: 'q_repeat_prayer', no: 'final_reflection' }
    },
    {
        id: 'q11_faith',
        text: "Par la foi, croyez-vous que J√©sus est ici en ce moment ?",
        type: 'question',
        next: { yes: 'q_repeat_prayer', no: 'final_reflection' }
    },
    {
        id: 'q_repeat_prayer',
        text: "Si tu veux vraiment suivre J√©sus, r√©p√®te cette pri√®re avec moi :\n\nJ√©sus, pardonne-moi mes p√©ch√©s.\nJ'ouvre la porte de mon c≈ìur.\nJe te fais Seigneur de ma vie.\nRemplis-moi de ton Esprit.\n\nAmen.",
        type: 'question_yes_only',
        question: "As-tu r√©p√©t√© cette pri√®re ?",
        special: true,
        next: { yes: 'final_prayer' }
    },
    {
        id: 'final_prayer',
        text: "acceptance_prayer", // This will trigger the professional layout
        type: 'final',
        special: true
    },
    {
        id: 'final_reflection',
        text: "Merci pour ton honn√™tet√©, {name}.\n\nJ√©sus respecte ton choix et continue de t'aimer.\n\n¬´ Car Dieu a tant aim√© le monde qu'il a donn√© son Fils unique. ¬ª\n‚Äî Jean 3:16\n\nLa porte reste ouverte. Toujours.\nTu peux revenir quand tu veux.\n\nQue Dieu te b√©nisse.",
        type: 'final'
    },
    {
        id: 'final_god_believes',
        text: "Dieu vous aime d'un amour infini.\n\n¬´ Car Dieu a tant aim√© le monde qu'il a donn√© son Fils unique, afin que quiconque croit en lui ne p√©risse pas, mais qu'il ait la vie √©ternelle. ¬ª\n‚Äî Jean 3:16\n\n¬´ J'ai mis devant toi la vie et la mort, la b√©n√©diction et la mal√©diction. Choisis la vie, afin que tu vives, toi et ta post√©rit√©. ¬ª\n‚Äî Deut√©ronome 30:19\n\nLa porte reste toujours ouverte.\nDieu vous attend, les bras ouverts.",
        type: 'final',
        special: true
    }
];

// === STATE ===
let currentLang = 'fr'; // Default language
let userName = '';
let currentQuestionId = 'q1';
let answers = {};
let autoAdvanceTimeout = null;
let questionHistory = []; // Track navigation history
let currentQuestionAnswered = false; // Track if current question was answered

// === TRANSLATION HELPER ===
function t(key) {
    const keys = key.split('.');
    let value = translations[currentLang];
    for (const k of keys) {
        value = value[k];
        if (!value) return key;
    }
    return value;
}

function getQuestionText(questionId) {
    // Special handling for different question types
    const translationKey = `questions.${questionId}`;
    return t(translationKey);
}

function getQuestionSubText(questionId) {
    // For questions that have a secondary question text
    const translationKey = `questions.${questionId}_question`;
    return t(translationKey);
}

// === DOM ELEMENTS ===
const languageScreen = document.getElementById('languageScreen');
const homeScreen = document.getElementById('homeScreen');
const nameScreen = document.getElementById('nameScreen');
const questionsScreen = document.getElementById('questionsScreen');
const finalScreen = document.getElementById('finalScreen');
const startBtn = document.getElementById('startBtn');
const nameForm = document.getElementById('nameForm');
const userNameInput = document.getElementById('userName');
const themeToggle = document.querySelector('.theme-toggle');
const cardsContainer = document.getElementById('cardsContainer');
const progressFill = document.getElementById('progressFill');
const progressCounter = document.getElementById('progressCounter');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const navButtons = document.getElementById('navButtons');
const languageButtons = document.querySelectorAll('.btn-language');

// === LANGUAGE MANAGEMENT ===
function handleLanguageSelection(lang) {
    currentLang = lang;
    localStorage.setItem('language', lang);
    updateHomeScreen();
    showScreen(homeScreen);
}

function updateHomeScreen() {
    const welcomeText = homeScreen.querySelector('.welcome-text');
    const startButton = homeScreen.querySelector('#startBtn');

    welcomeText.innerHTML = `${t('home.verse')}<br><span style="font-size: 0.7em; font-style: italic; opacity: 0.9;">‚Äî ${t('home.reference')}</span>`;
    startButton.textContent = t('home.startBtn');
}

function updateNameScreen() {
    const nameTitle = nameScreen.querySelector('.name-title');
    const nameInput = nameScreen.querySelector('#userName');
    const continueBtn = nameScreen.querySelector('.btn-primary');

    nameTitle.textContent = t('name.title');
    nameInput.placeholder = t('name.placeholder');
    continueBtn.textContent = t('name.continueBtn');
}

function updateNavigationButtonText() {
    prevBtn.querySelector('span').textContent = t('navigation.previous');
    nextBtn.querySelector('span').textContent = t('navigation.next');
}

// === INITIALIZATION ===
function init() {
    loadTheme();
    loadLanguage();
    setupEventListeners();
}

function loadLanguage() {
    const savedLang = localStorage.getItem('language');
    if (savedLang) {
        currentLang = savedLang;
    }
}

// === THEME MANAGEMENT ===
function loadTheme() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeIcon(savedTheme);
}

function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateThemeIcon(newTheme);
}

function updateThemeIcon(theme) {
    const icon = document.querySelector('.theme-icon');
    icon.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
}

// === NAME HANDLING ===
function handleNameSubmit(e) {
    e.preventDefault();
    userName = userNameInput.value.trim();
    if (userName) {
        localStorage.setItem('userName', userName);
        showQuestionnaire();
    }
}

// === QUESTION FLOW ===
function getQuestionById(id) {
    return questionFlow.find(q => q.id === id);
}

function showQuestionnaire() {
    showScreen(questionsScreen);
    updateNavigationButtonText();
    currentQuestionId = 'q1_image';
    questionHistory = ['q1_image'];
    displayQuestion(currentQuestionId);
}

function displayQuestion(questionId) {
    const question = getQuestionById(questionId);
    if (!question) return;

    // Check if question was already answered
    if (question.type === 'question' || question.type === 'question_three' || question.type === 'question_yes_only') {
        currentQuestionAnswered = answers[questionId] !== undefined;
    } else {
        currentQuestionAnswered = true; // Text questions don't need answers
    }

    // Clear previous content
    cardsContainer.innerHTML = '';
    clearTimeout(autoAdvanceTimeout);

    // Create card
    const card = document.createElement('div');
    card.className = 'question-card active';
    if (question.special) {
        card.classList.add('special-card');
    }

    // Get translated text - Replace all occurrences of {name}
    let displayText = getQuestionText(questionId).replaceAll('{name}', userName);

    const questionText = document.createElement('h2');
    questionText.className = 'question-text';
    questionText.style.whiteSpace = 'pre-line';
    questionText.textContent = displayText;

    // Add class for long text (more than 200 characters)
    if (displayText.length > 200) {
        card.classList.add('has-long-text');
    }

    card.appendChild(questionText);

    // Add additional question if exists
    const subText = getQuestionSubText(questionId);
    if (subText && subText !== `questions.${questionId}_question`) {
        const subQuestion = document.createElement('p');
        subQuestion.className = 'question-text';
        subQuestion.style.fontSize = '1.5rem';
        subQuestion.style.marginTop = '2rem';
        subQuestion.textContent = subText;
        card.appendChild(subQuestion);
    }

    // Add answer buttons inside card for question types
    if (question.type === 'question' || question.type === 'question_three' || question.type === 'question_yes_only') {
        const answerBtnsContainer = document.createElement('div');
        answerBtnsContainer.className = 'answer-buttons';
        answerBtnsContainer.style.display = 'flex';

        const yesBtn = document.createElement('button');
        yesBtn.className = 'btn-answer btn-yes';
        yesBtn.textContent = t('answers.yes');
        yesBtn.setAttribute('type', 'button');
        yesBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            handleAnswer('yes');
        });

        answerBtnsContainer.appendChild(yesBtn);

        // Add doubt button for question_three type
        if (question.type === 'question_three') {
            const doubtBtn = document.createElement('button');
            doubtBtn.className = 'btn-answer btn-doubt';
            doubtBtn.textContent = t('answers.doubt');
            doubtBtn.setAttribute('type', 'button');
            doubtBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                handleAnswer('doubt');
            });
            answerBtnsContainer.appendChild(doubtBtn);
        }

        // Add No button only if not question_yes_only
        if (question.type !== 'question_yes_only') {
            const noBtn = document.createElement('button');
            noBtn.className = 'btn-answer btn-no';
            noBtn.textContent = t('answers.no');
            noBtn.setAttribute('type', 'button');
            noBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                handleAnswer('no');
            });
            answerBtnsContainer.appendChild(noBtn);
        }

        card.appendChild(answerBtnsContainer);
    }

    cardsContainer.appendChild(card);

    // Update progress
    updateProgress();

    // Show/hide navigation buttons based on question type
    if (question.type === 'final') {
        navButtons.style.display = 'none';
        // Show final screen immediately
        showFinalScreen();
    } else {
        navButtons.style.display = 'flex';
    }

    // Update navigation buttons state
    updateNavigationButtons();
}

function advanceToNext(currentId) {
    const question = getQuestionById(currentId);

    // Determine next question
    let nextId = null;

    // Check if there's a custom nextId
    if (question.nextId) {
        nextId = question.nextId;
    } else if (question.type === 'text') {
        // Find next question in sequence for text types
        const currentIndex = questionFlow.findIndex(q => q.id === currentId);
        if (currentIndex < questionFlow.length - 1) {
            nextId = questionFlow[currentIndex + 1].id;
        }
    }

    if (nextId) {
        navigateToQuestion(nextId);
    }
}

function navigateToQuestion(questionId) {
    // Add to history if not already the last item
    if (questionHistory[questionHistory.length - 1] !== questionId) {
        questionHistory.push(questionId);
    }
    currentQuestionId = questionId;
    displayQuestion(questionId);
}

function goToPrevQuestion() {
    if (questionHistory.length > 1) {
        // Remove current question
        questionHistory.pop();
        // Get previous question
        const prevId = questionHistory[questionHistory.length - 1];
        currentQuestionId = prevId;
        displayQuestion(prevId);
    }
}

function goToNextQuestion() {
    const question = getQuestionById(currentQuestionId);

    if (question.type === 'text') {
        // For text questions, advance automatically
        advanceToNext(currentQuestionId);
    } else if (question.type === 'question') {
        // For questions, we can't auto-advance without an answer
        // Just try to go to the first possible next
        if (question.next && question.next.yes) {
            navigateToQuestion(question.next.yes);
        }
    }
}

function handleAnswer(answer) {
    const question = getQuestionById(currentQuestionId);
    if (!question || !question.next) return;

    // Mark question as answered
    currentQuestionAnswered = true;
    updateNavigationButtons();

    // Save answer
    answers[currentQuestionId] = {
        answer: answer,
        timestamp: new Date().toISOString()
    };
    localStorage.setItem('answers', JSON.stringify(answers));

    // Visual feedback on the clicked button
    const activeCard = document.querySelector('.question-card.active');
    if (activeCard) {
        const buttons = activeCard.querySelectorAll('.btn-answer');
        buttons.forEach(btn => {
            btn.style.opacity = '0.5';
        });

        const clickedBtn = Array.from(buttons).find(btn =>
            btn.textContent.toLowerCase() === (answer === 'yes' ? 'oui' : 'non')
        );

        if (clickedBtn) {
            clickedBtn.style.opacity = '1';
            clickedBtn.style.transform = 'scale(0.95)';
            setTimeout(() => {
                clickedBtn.style.transform = '';
            }, 200);
        }
    }

    // Navigate to next question based on answer
    const nextId = question.next[answer];
    if (nextId) {
        setTimeout(() => {
            navigateToQuestion(nextId);
        }, 400);
    }
}

// === PROGRESS ===
function updateProgress() {
    const currentIndex = questionFlow.findIndex(q => q.id === currentQuestionId);
    const progress = ((currentIndex + 1) / questionFlow.length) * 100;
    progressFill.style.width = `${progress}%`;
    progressCounter.textContent = `${t('progress.step')} ${currentIndex + 1} / ${questionFlow.length}`;
}

function updateNavigationButtons() {
    // Disable prev button if we're at the start of history
    prevBtn.disabled = questionHistory.length <= 1;

    // Disable next button based on conditions
    const question = getQuestionById(currentQuestionId);

    if (question && question.type === 'final') {
        nextBtn.disabled = true; // Final screen
    } else if (question && (question.type === 'question' || question.type === 'question_three' || question.type === 'question_yes_only') && !currentQuestionAnswered) {
        nextBtn.disabled = true; // Question not answered yet
    } else {
        nextBtn.disabled = false; // Can navigate
    }
}

// === SCREEN TRANSITIONS ===
function showScreen(screen) {
    document.querySelectorAll('.screen').forEach(s => {
        s.classList.remove('active');
        s.setAttribute('aria-hidden', 'true');
    });
    screen.classList.add('active');
    screen.setAttribute('aria-hidden', 'false');
}

function showFinalScreen() {
    // Get the final question to display its message
    const finalQuestion = getQuestionById(currentQuestionId);

    // Clear and create final content
    finalScreen.innerHTML = '';

    const finalContent = document.createElement('div');
    finalContent.className = 'final-content';

    // Check if this is the acceptance prayer (final_prayer)
    if (finalQuestion && finalQuestion.id === 'final_prayer') {
        // Create professional layout for the acceptance message
        finalContent.innerHTML = `
            <div class="final-wrapper">
                <div class="final-header">
                    <div class="celebration-icon">üéâ</div>
                    <h1 class="final-title">${t('finalScreen.title')}</h1>
                </div>

                <div class="prayer-section">
                    <p class="prayer-text">${t('finalScreen.prayerText')}</p>
                    <p class="amen">${t('finalScreen.amen')}</p>
                </div>

                <div class="welcome-section">
                    <p class="welcome-message">${t('finalScreen.welcomeMessage')}</p>
                </div>

                <div class="journey-section">
                    <h2 class="section-title">${t('finalScreen.journeyTitle')}</h2>
                    <p class="section-text">${t('finalScreen.journeyText')}</p>
                </div>

                <div class="teaching-section">
                    <h2 class="section-title">${t('finalScreen.teachingTitle')}</h2>
                    <p class="section-text">${t('finalScreen.teachingText')}</p>

                    <div class="hearts-grid">
                        <div class="heart-card">
                            <div class="heart-icon">‚úã</div>
                            <h3 class="heart-title">${t('finalScreen.heart1Title')}</h3>
                            <p class="heart-description">${t('finalScreen.heart1Desc')}</p>
                            <p class="heart-consequence">${t('finalScreen.heart1Consequence')}</p>
                        </div>

                        <div class="heart-card">
                            <div class="heart-icon">ü™®</div>
                            <h3 class="heart-title">${t('finalScreen.heart2Title')}</h3>
                            <p class="heart-description">${t('finalScreen.heart2Desc')}</p>
                            <p class="heart-consequence">${t('finalScreen.heart2Consequence')}</p>
                        </div>

                        <div class="heart-card">
                            <div class="heart-icon">üåø</div>
                            <h3 class="heart-title">${t('finalScreen.heart3Title')}</h3>
                            <p class="heart-description">${t('finalScreen.heart3Desc')}</p>
                            <p class="heart-consequence">${t('finalScreen.heart3Consequence')}</p>
                        </div>

                        <div class="heart-card good-heart">
                            <div class="heart-icon">‚ù§Ô∏è</div>
                            <h3 class="heart-title">${t('finalScreen.heart4Title')}</h3>
                            <p class="heart-description">${t('finalScreen.heart4Desc')}</p>
                            <p class="heart-consequence">${t('finalScreen.heart4Consequence')}</p>
                        </div>
                    </div>
                </div>

                <div class="encouragement-section">
                    <h2 class="section-title">${t('finalScreen.encouragementTitle')}</h2>
                    <p class="section-text">${t('finalScreen.encouragementText')}</p>
                    <ul class="encouragement-list">
                        <li>${t('finalScreen.encouragement1')}</li>
                        <li>${t('finalScreen.encouragement2')}</li>
                        <li>${t('finalScreen.encouragement3')}</li>
                    </ul>
                    <blockquote class="bible-quote">
                        "${t('finalScreen.bibleQuote')}"<br>
                        <cite>${t('finalScreen.bibleQuoteRef')}</cite>
                    </blockquote>
                </div>

                <div class="book-section">
                    <h2 class="section-title">${t('finalScreen.bookTitle')}</h2>
                    <p class="section-text">${t('finalScreen.bookSubtitle')}</p>
                    <p class="book-description">${t('finalScreen.bookDesc1')}</p>
                    <p class="book-description">${t('finalScreen.bookDesc2')}</p>

                    <a href="${currentLang === 'fr' ? 'suivre_jesus.pdf' : 'FollowingJesus_ebook_SamuelDeuth.pdf'}" download class="btn-download">
                        <span class="download-icon">üì•</span>
                        <span>${t('finalScreen.downloadBtn')}</span>
                    </a>
                </div>

                <div class="final-actions">
                    <button class="btn-restart" id="restartBtn">${t('finalScreen.restartBtn')}</button>
                </div>
            </div>
        `;

        // Add event listener to restart button
        const restartBtn = finalContent.querySelector('#restartBtn');
        restartBtn.addEventListener('click', restartQuestionnaire);
    } else {
        // For other final screens, use the original simple layout
        // Add special background if needed
        if (finalQuestion && finalQuestion.special) {
            finalContent.style.backgroundImage = "url('assets/Sticker-2-700x700.webp')";
            finalContent.style.backgroundSize = 'contain';
            finalContent.style.backgroundPosition = 'center';
            finalContent.style.backgroundRepeat = 'no-repeat';
            finalContent.style.position = 'relative';

            // Add overlay for better text readability
            const overlay = document.createElement('div');
            overlay.style.position = 'absolute';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.background = 'rgba(0, 0, 0, 0.6)';
            overlay.style.borderRadius = '20px';
            finalContent.appendChild(overlay);
        }

        const contentWrapper = document.createElement('div');
        contentWrapper.style.position = 'relative';
        contentWrapper.style.zIndex = '1';

        const finalMessage = document.createElement('p');
        finalMessage.className = 'final-message';
        finalMessage.style.color = finalQuestion && finalQuestion.special ? 'white' : 'var(--text-primary)';
        finalMessage.style.fontSize = 'clamp(1.1rem, 2.5vw, 1.4rem)';
        finalMessage.style.fontWeight = '400';
        // Replace {name} with actual user name and use translations
        const finalText = finalQuestion ? getQuestionText(finalQuestion.id).replaceAll('{name}', userName) : t('finalScreen.welcomeMessage');
        finalMessage.textContent = finalText;

        contentWrapper.appendChild(finalMessage);

        // Add restart button
        const restartButton = document.createElement('button');
        restartButton.className = 'btn-primary';
        restartButton.textContent = t('finalScreen.restartBtn');
        restartButton.style.marginTop = '2rem';
        restartButton.addEventListener('click', restartQuestionnaire);

        contentWrapper.appendChild(restartButton);
        finalContent.appendChild(contentWrapper);
    }

    finalScreen.appendChild(finalContent);
    showScreen(finalScreen);
}

function restartQuestionnaire() {
    userName = '';
    userNameInput.value = '';
    currentQuestionId = 'q1_image';
    questionHistory = [];
    answers = {};
    localStorage.removeItem('answers');
    localStorage.removeItem('userName');
    clearTimeout(autoAdvanceTimeout);
    showScreen(homeScreen);
}

// === KEYBOARD NAVIGATION ===
function handleKeyboard(e) {
    if (questionsScreen.classList.contains('active')) {
        const question = getQuestionById(currentQuestionId);

        // Navigation arrows work on all questions
        switch(e.key) {
            case 'ArrowLeft':
                e.preventDefault();
                if (!prevBtn.disabled) {
                    goToPrevQuestion();
                }
                break;
            case 'ArrowRight':
                e.preventDefault();
                if (!nextBtn.disabled) {
                    goToNextQuestion();
                }
                break;
        }

        // Answer shortcuts only work on question type
        if (question && (question.type === 'question' || question.type === 'question_three' || question.type === 'question_yes_only')) {
            switch(e.key) {
                case '1':
                case 'o':
                case 'O':
                    e.preventDefault();
                    handleAnswer('yes');
                    break;
                case '2':
                case 'n':
                case 'N':
                    if (question.type !== 'question_yes_only') {
                        e.preventDefault();
                        handleAnswer('no');
                    }
                    break;
                case '3':
                case 'd':
                case 'D':
                    if (question.type === 'question_three') {
                        e.preventDefault();
                        handleAnswer('doubt');
                    }
                    break;
                case 'Enter':
                    e.preventDefault();
                    handleAnswer('yes');
                    break;
            }
        }
    }
}

// === EVENT LISTENERS ===
function setupEventListeners() {
    // Language selection
    languageButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const lang = btn.getAttribute('data-lang');
            handleLanguageSelection(lang);
        });
    });

    // Theme toggle
    themeToggle.addEventListener('click', toggleTheme);

    // Screen navigation
    startBtn.addEventListener('click', () => {
        updateNameScreen();
        showScreen(nameScreen);
    });
    nameForm.addEventListener('submit', handleNameSubmit);

    // Question navigation buttons
    prevBtn.addEventListener('click', goToPrevQuestion);
    nextBtn.addEventListener('click', goToNextQuestion);

    // Keyboard navigation
    document.addEventListener('keydown', handleKeyboard);
}

// === ACCESSIBILITY ===
const style = document.createElement('style');
style.textContent = `
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border-width: 0;
    }
`;
document.head.appendChild(style);

// === START APPLICATION ===
document.addEventListener('DOMContentLoaded', init);

// === PERFORMANCE OPTIMIZATION ===
// Lazy load video
if ('IntersectionObserver' in window) {
    const video = document.querySelector('video');
    if (video) {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    video.play().catch(() => console.log('Video autoplay may be blocked'));
                    observer.unobserve(video);
                }
            });
        });
        observer.observe(video);
    }
}

// Preload special card image
const specialImage = new Image();
specialImage.src = 'assets/Sticker-2-700x700.webp';
